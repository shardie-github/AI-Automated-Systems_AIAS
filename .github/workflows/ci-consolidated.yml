name: CI/CD Pipeline (Consolidated)

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Code Quality Checks (Run in parallel)
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run typecheck

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run format:check

  # ============================================================================
  # Security & Dependency Checks (Run in parallel)
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run audit:security || echo "Security audit completed with warnings"
      - run: pnpm run audit:deps || echo "Dependency audit completed"

  # ============================================================================
  # Tests (Run after code quality checks)
  # ============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run test -- --run
      - uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # Build (Run after tests pass)
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: |
          set -euo pipefail
          echo "üî® Building application..."
          if ! pnpm run build; then
            echo "‚ùå Build failed"
            exit 1
          fi
          echo "‚úÖ Build completed successfully"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://localhost:5432/test' }}
          SKIP_PRISMA_GENERATE: ${{ !secrets.DATABASE_URL }}
      - run: |
          set -euo pipefail
          echo "üîç Validating build output..."
          if ! pnpm run validate:build; then
            echo "‚ùå Build validation failed"
            exit 1
          fi
          echo "‚úÖ Build validation passed"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts
          path: .next/
          retention-days: 7

  # ============================================================================
  # E2E Tests (Run after build)
  # ============================================================================
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm exec playwright install --with-deps
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/
      - run: pnpm run start &
        env:
          PORT: 3000
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://localhost:5432/test' }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || '' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || '' }}
      - run: sleep 15
      - run: pnpm run test:e2e -- tests/e2e/critical-flows.spec.ts
        env:
          BASE_URL: http://localhost:3000
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # Frontend Deployment (Run on PR and main branch)
  # NOTE: Migrations run automatically on server startup, not in CI/CD
  # ============================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build, test-e2e]
    if: |
      (github.event_name == 'pull_request') || 
      (github.ref == 'refs/heads/main' && github.event_name == 'push')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      - run: pnpm install --frozen-lockfile
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/
      - name: Pull Vercel environment
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if ! npx vercel@latest pull --yes --environment=preview --token="${{ secrets.VERCEL_TOKEN }}"; then
              echo "‚ùå Failed to pull Vercel preview environment"
              exit 1
            fi
          else
            if ! npx vercel@latest pull --yes --environment=production --token="${{ secrets.VERCEL_TOKEN }}"; then
              echo "‚ùå Failed to pull Vercel production environment"
              exit 1
            fi
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: Build for Vercel
        run: |
          set -euo pipefail
          echo "üî® Building for Vercel..."
          if ! npx vercel@latest build --token="${{ secrets.VERCEL_TOKEN }}"; then
            echo "‚ùå Vercel build failed"
            exit 1
          fi
          echo "‚úÖ Vercel build successful"
          
          # Validate build output
          echo "üîç Validating Vercel build output..."
          if ! pnpm run validate:build; then
            echo "‚ùå Build validation failed"
            exit 1
          fi
          echo "‚úÖ Build validation passed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: Deploy to Vercel
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if ! npx vercel@latest deploy --prebuilt --token="${{ secrets.VERCEL_TOKEN }}" --prod=false; then
              echo "‚ùå Preview deployment failed"
              exit 1
            fi
            echo "‚úÖ Preview deployment successful"
          else
            if ! npx vercel@latest deploy --prebuilt --token="${{ secrets.VERCEL_TOKEN }}" --prod=true; then
              echo "‚ùå Production deployment failed"
              exit 1
            fi
            echo "‚úÖ Production deployment successful"
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
