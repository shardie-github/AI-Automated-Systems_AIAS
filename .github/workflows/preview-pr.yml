name: PR Preview & Quality Gates

on:
  # Changed to manual trigger only - preview deployments are opt-in
  # pull_request:
  #   branches: [main]
  workflow_dispatch:

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      NEXT_TELEMETRY_DISABLED: 1
      NEXT_PUBLIC_SITE_URL: http://localhost:3000
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck & Lint
        run: |
          pnpm run typecheck || true
          pnpm run lint || true

      - name: Build Next.js
        run: pnpm run build

      - name: Start server
        run: pnpm run start-ci &
      
      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Lighthouse (mobile)
        run: pnpm run lhci

      - name: Accessibility (Pa11y axe)
        run: pnpm run a11y

      - name: Upload QA Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: |
            .lighthouseci
            pa11y-ci-results.json

      # OPTIONAL: Dry-run Supabase schema check (no changes applied)
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
      - name: Supabase login/link (dry-run)
        run: |
          pnpm run supa:login
          pnpm run supa:link
          pnpm run supa:status

      - name: Vercel Pull & Build (Preview)
        run: |
          pnpm run vercel:pull
          pnpm run vercel:build
          pnpm run vercel:deploy:preview > .vercel-url.txt

      - name: Comment Preview URL
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: .vercel-url.txt